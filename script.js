const casasTech = {
    'comandante_ia': {
        nome: 'Casa do Comandante de IA',
        emoji: 'ü§ñ',
        lema: 'Onde os dados viram insights e o futuro se constr√≥i!',
        descricao: 'Voc√™ √© um estrategista digital nato! Esta casa re√∫ne mentes anal√≠ticas que transformam dados em decis√µes inteligentes. Aqui, voc√™ aprender√° a comandar algoritmos, criar dashboards que revelam segredos ocultos nos n√∫meros e usar intelig√™ncia artificial para resolver problemas complexos.',
        caracteristicas: [
            'üìä An√°lise de dados e Business Intelligence',
            'üß† Intelig√™ncia Artificial e Machine Learning',
            'üìà Dashboards e visualiza√ß√µes interativas',
            'üîç Descoberta de insights estrat√©gicos',
            '‚ö° Automa√ß√£o de processos com IA'
        ],
        img: 'img/cia.png',
        cursos: [
            {
                nome: 'Power BI',
                descricao: 'Domine a ferramenta mais poderosa de Business Intelligence do mercado. Aprenda a criar dashboards profissionais, conectar m√∫ltiplas fontes de dados e transformar n√∫meros em insights visuais que impressionam. Ideal para quem quer se destacar na an√°lise de dados.',
                link: 'http://sp.senac.br/cursos-livres/curso-de-power-bi'
            },
            {
                nome: 'Forma√ß√£o Excel Avan√ßado',
                descricao: 'V√° al√©m das planilhas b√°sicas! Descubra f√≥rmulas avan√ßadas, tabelas din√¢micas, macros e automa√ß√µes que v√£o revolucionar sua produtividade. Torne-se um ninja do Excel e impressione em qualquer empresa.',
                link: 'https://www.sp.senac.br/cursos-livres/curso-de-formacao-excel-do-basico-ao-avancado'
            },
            {
                nome: 'Programador de Sistemas',
                descricao: 'Entre no mundo da programa√ß√£o criando sistemas completos do zero. Aprenda l√≥gica de programa√ß√£o, bancos de dados, desenvolvimento web e mobile. O curso perfeito para quem quer construir o futuro digital.',
                link: 'https://www.sp.senac.br/cursos-livres/curso-de-programador-de-sistemas'
            },
            {
                nome: 'Introdu√ß√£o √† Programa√ß√£o',
                descricao: 'Seus primeiros passos no universo tech! Descubra os fundamentos da programa√ß√£o de forma did√°tica e divertida. Aprenda a pensar como um programador e crie seus primeiros c√≥digos.',
                link: 'https://www.sp.senac.br/cursos-livres/curso-de-introducao-a-pratica-da-programacao'
            }
        ]
    },
    'engenheiro_automacao': {
        nome: 'Casa do Engenheiro de Automa√ß√£o e Rob√≥tica',
        emoji: '‚öôÔ∏è',
        lema: 'Persist√™ncia, l√≥gica e cafe√≠na no sangue!',
        descricao: 'Voc√™ √© um construtor nato! Esta casa √© o lar dos makers, dos que gostam de colocar a m√£o na massa e ver suas cria√ß√µes ganharem vida.',
        caracteristicas: [
            'ü§ñ Rob√≥tica e automa√ß√£o industrial',
            'üîß Programa√ß√£o de sistemas embarcados',
            '‚ö° Internet das Coisas (IoT)',
            'üè≠ Controle de processos automatizados',
            'üõ†Ô∏è Prototipagem e desenvolvimento de hardware'
        ],
        img: 'img/eia.png',
        cursos: [
            {
                nome: 'T√©cnico em Inform√°tica',
                descricao: 'Forma√ß√£o completa em tecnologia! Aprenda hardware, software, redes, programa√ß√£o e manuten√ß√£o de sistemas. O curso mais abrangente para quem quer dominar todos os aspectos da inform√°tica e estar preparado para qualquer desafio tech.',
                link: 'https://www.sp.senac.br/cursos-tecnicos/curso-tecnico-em-informatica'

            },
            {
                nome: 'Virtualiza√ß√£o com Hyper-V',
                descricao: 'Domine a arte da virtualiza√ß√£o! Aprenda a criar e gerenciar m√°quinas virtuais, otimizar recursos de servidor e construir infraestruturas de TI modernas e eficientes. Essencial para a era da computa√ß√£o em nuvem.',
                link: 'https://www.sp.senac.br/cursos-livres/curso-de-virtualizacao-com-windows-server-hyper-v'
            },
            {
                nome: 'Fundamentos do Azure',
                descricao: 'Entre no mundo da computa√ß√£o em nuvem com a plataforma l√≠der do mercado. Aprenda a criar, configurar e gerenciar recursos na nuvem da Microsoft. Seu passaporte para o futuro da infraestrutura de TI.',
                link: 'https://www.sp.senac.br/cursos-livres/curso-de-fundamentos-do-microsoft-azure'
            },
            {
                nome: 'Programador de Sistemas',
                descricao: 'Construa sistemas robustos e escal√°veis! Aprenda as melhores pr√°ticas de desenvolvimento, arquitetura de software e metodologias √°geis. Torne-se o programador que as empresas procuram.',
                link: 'https://www.sp.senac.br/cursos-livres/curso-de-programador-de-sistemas'
            }
        ]
    },
    'mestre_vr': {
        nome: 'Casa do Mestre da Realidade Virtual',
        emoji: 'üï∂Ô∏è',
        lema: 'Aqui a realidade √© s√≥ o come√ßo!',
        descricao: 'Voc√™ √© um vision√°rio digital! Esta casa abriga os criadores de mundos, os que transformam imagina√ß√£o em experi√™ncias imersivas.',
        caracteristicas: [
            'üéÆ Desenvolvimento de jogos e aplica√ß√µes',
            'ü•Ω Realidade Virtual e Aumentada',
            'üé® Design de interfaces e experi√™ncias',
            'üé¨ Storytelling digital e narrativas interativas',
            'üåê Cria√ß√£o de mundos virtuais imersivos'
        ],
        img: 'img/mvr.png',
        cursos: [
            {
                nome: 'Programador de Sistemas',
                descricao: 'A base para criar experi√™ncias digitais incr√≠veis! Aprenda programa√ß√£o orientada a objetos, desenvolvimento de interfaces e cria√ß√£o de aplica√ß√µes interativas. Seu primeiro passo para o mundo dos games e VR.',
                link: 'https://www.sp.senac.br/cursos-livres/curso-de-programador-de-sistemas'
            },
            {
                nome: 'T√©cnico em Inform√°tica',
                descricao: 'Forma√ß√£o completa para dominar todas as tecnologias! Desde hardware para VR at√© programa√ß√£o de jogos, este curso te prepara para trabalhar com as mais diversas plataformas e dispositivos imersivos.',
                link: 'https://www.sp.senac.br/cursos-tecnicos/curso-tecnico-em-informatica'
            },
            {
                nome: 'Introdu√ß√£o √† Programa√ß√£o',
                descricao: 'Comece sua jornada criativa! Aprenda os fundamentos da programa√ß√£o com foco em cria√ß√£o de conte√∫do interativo. O primeiro passo para desenvolver jogos, apps e experi√™ncias digitais.',
                link: 'https://www.sp.senac.br/cursos-livres/curso-de-introducao-a-pratica-da-programacao'
            },
            {
                nome: 'Power BI',
                descricao: 'Visualize dados como nunca antes! Crie dashboards interativos e imersivos que transformam an√°lise de dados em experi√™ncias visuais impactantes. Perfeito para quem quer inovar na apresenta√ß√£o de informa√ß√µes.',
                link: 'https://www.sp.senac.br/cursos-livres/curso-de-power-bi'
            }
        ]
    },
    'hacker_futuro': {
        nome: 'Casa Hackeando o Futuro',
        emoji: 'üõ°Ô∏è',
        lema: 'Protegendo redes, criando liberdade digital!',
        descricao: 'Voc√™ √© um guardi√£o digital! Esta casa re√∫ne os defensores do ciberespa√ßo, aqueles que protegem dados, sistemas e pessoas no mundo digital. ',
        caracteristicas: [
            'üîê Seguran√ßa da informa√ß√£o e criptografia',
            'üïµÔ∏è Ethical hacking e testes de penetra√ß√£o',
            'üõ°Ô∏è Prote√ß√£o de redes e sistemas',
            'üîç Forense digital e investiga√ß√£o',
            '‚ö†Ô∏è Gest√£o de riscos e compliance'
        ],
        img: 'img/hf.png',
        cursos: [
            {
                nome: 'Analista de Seguran√ßa da Informa√ß√£o',
                descricao: 'Torne-se um guardi√£o digital! Aprenda a identificar vulnerabilidades, implementar prote√ß√µes avan√ßadas e responder a incidentes de seguran√ßa. O curso mais completo para quem quer proteger o mundo digital.',
                link: 'https://www.sp.senac.br/cursos-livres/curso-de-analista-de-seguranca-da-informacao'
            },
            {
                nome: 'Seguran√ßa em Servidores Linux',
                descricao: 'Domine a seguran√ßa do sistema operacional mais usado em servidores! Aprenda hardening, monitoramento, detec√ß√£o de intrus√µes e resposta a incidentes em ambientes Linux.',
                link: 'https://www.sp.senac.br/cursos-livres/curso-de-seguranca-em-servidores-linux'

            },
            {
                nome: 'T√©cnico em Inform√°tica',
                descricao: 'Ao longo do curso, voc√™ se torna especialista em hardware, software, redes, programa√ß√£o, banco de dados e at√© desenvolvimento web.',
                link: 'https://www.sp.senac.br/cursos-tecnicos/curso-tecnico-em-informatica'
            },
            {
                nome: 'Fundamentos do Azure',
                descricao: 'Seguran√ßa na nuvem √© o futuro! Aprenda a implementar e gerenciar solu√ß√µes seguras na plataforma Azure, incluindo identity management, network security e compliance.',
                link: 'https://www.sp.senac.br/cursos-livres/curso-de-fundamentos-do-microsoft-azure'

            }
        ]
    }
};

// Perguntas Acess√≠veis para Iniciantes
const perguntas = [
    {
        id: 1,
        texto: "E a√≠! üëã Bem-vindo ao universo tech do Senac! Vamos descobrir qual √°rea combina mais com voc√™? Primeiro, como voc√™ gosta de passar seu tempo livre?",
        opcoes: [
            {
                texto: "Organizando planilhas, listas ou analisando informa√ß√µes üìäüìã",
                pontos: { comandante_ia: 3, hacker_futuro: 1, mestre_vr: 1 }
            },
            {
                texto: "Desmontando aparelhos ou consertando coisas quebradas üîß‚öôÔ∏è",
                pontos: { engenheiro_automacao: 3, hacker_futuro: 2, comandante_ia: 1 }
            },
            {
                texto: "Desenhando, editando fotos ou criando conte√∫do visual üé®üì±",
                pontos: { mestre_vr: 3, comandante_ia: 1, engenheiro_automacao: 1 }
            },
            {
                texto: "Pesquisando sobre privacidade online e senhas seguras üîíüïµÔ∏è",
                pontos: { hacker_futuro: 3, engenheiro_automacao: 1, mestre_vr: 1 }
            }
        ]
    },
    {
        id: 2,
        texto: "Legal! üî• Na escola, qual mat√©ria voc√™ sempre se deu melhor?",
        opcoes: [
            {
                texto: "Matem√°tica e c√°lculos - adoro n√∫meros e estat√≠sticas! üßÆüìà",
                pontos: { comandante_ia: 3, engenheiro_automacao: 2, hacker_futuro: 1 }
            },
            {
                texto: "F√≠sica e qu√≠mica - gosto de entender como as coisas funcionam üî¨‚öóÔ∏è",
                pontos: { engenheiro_automacao: 3, hacker_futuro: 1, comandante_ia: 2 }
            },
            {
                texto: "Artes e portugu√™s - sou criativo e gosto de me expressar üé≠üìù",
                pontos: { mestre_vr: 3, comandante_ia: 1, engenheiro_automacao: 1 }
            },
            {
                texto: "Hist√≥ria e geografia - gosto de investigar e descobrir coisas üó∫Ô∏èüîç",
                pontos: { hacker_futuro: 3, mestre_vr: 1, comandante_ia: 2 }
            }
        ]
    },
    {
        id: 3,
        texto: "Show! üöÄ Quando voc√™ usa o celular, o que mais faz?",
        opcoes: [
            {
                texto: "Uso apps de produtividade, planilhas ou leio not√≠cias üì±üíº",
                pontos: { comandante_ia: 3, hacker_futuro: 2, mestre_vr: 1 }
            },
            {
                texto: "Pesquiso tutoriais de como consertar ou fazer coisas üõ†Ô∏èüì∫",
                pontos: { engenheiro_automacao: 3, comandante_ia: 1, hacker_futuro: 2 }
            },
            {
                texto: "Edito fotos, fa√ßo stories ou assisto v√≠deos criativos üì∏üé¨",
                pontos: { mestre_vr: 3, engenheiro_automacao: 1, comandante_ia: 2 }
            },
            {
                texto: "Configuro privacidade e pesquiso sobre seguran√ßa digital üîêüì≤",
                pontos: { hacker_futuro: 3, engenheiro_automacao: 2, mestre_vr: 1 }
            }
        ]
    },
    {
        id: 4,
        texto: "Perfeito! üíØ Se voc√™ pudesse escolher um superpoder, qual seria?",
        opcoes: [
            {
                texto: "Processar informa√ß√µes super r√°pido e prever tend√™ncias üß†‚ö°",
                pontos: { comandante_ia: 3, hacker_futuro: 1, mestre_vr: 2 }
            },
            {
                texto: "Consertar qualquer coisa s√≥ de tocar nela üîß‚ú®",
                pontos: { engenheiro_automacao: 3, hacker_futuro: 2, comandante_ia: 1 }
            },
            {
                texto: "Criar mundos virtuais e dar vida √†s minhas ideias üåüüé®",
                pontos: { mestre_vr: 3, comandante_ia: 2, engenheiro_automacao: 1 }
            },
            {
                texto: "Detectar mentiras e proteger pessoas de perigos invis√≠veis üõ°Ô∏èüëÅÔ∏è",
                pontos: { hacker_futuro: 3, engenheiro_automacao: 1, mestre_vr: 2 }
            }
        ]
    },
    {
        id: 5,
        texto: "Quase l√°! üéâ O que mais te deixa empolgado quando pensa no futuro?",
        opcoes: [
            {
                texto: "Trabalhar com dados para ajudar empresas a crescer üìäüè¢",
                pontos: { comandante_ia: 3, hacker_futuro: 2, mestre_vr: 1 }
            },
            {
                texto: "Construir rob√¥s ou sistemas que facilitam a vida das pessoas ü§ñüè†",
                pontos: { engenheiro_automacao: 3, comandante_ia: 1, hacker_futuro: 2 }
            },
            {
                texto: "Criar jogos, apps ou experi√™ncias digitais incr√≠veis üéÆüí´",
                pontos: { mestre_vr: 3, engenheiro_automacao: 1, comandante_ia: 2 }
            },
            {
                texto: "Proteger pessoas e empresas de crimes digitais üîíü¶∏",
                pontos: { hacker_futuro: 3, engenheiro_automacao: 2, mestre_vr: 1 }
            }
        ]
    },
    {
        id: 6,
        texto: "√öltima pergunta! üèÅ Seus amigos sempre dizem que voc√™ √© uma pessoa:",
        opcoes: [
            {
                texto: "Organizada e que sempre tem as melhores dicas e informa√ß√µes üìöüéØ",
                pontos: { comandante_ia: 3, hacker_futuro: 1, mestre_vr: 2 }
            },
            {
                texto: "Pr√°tica e que resolve qualquer problema com as pr√≥prias m√£os üí™üîß",
                pontos: { engenheiro_automacao: 3, hacker_futuro: 2, comandante_ia: 1 }
            },
            {
                texto: "Criativa e que sempre tem ideias inovadoras e diferentes üí°üé®",
                pontos: { mestre_vr: 3, comandante_ia: 2, engenheiro_automacao: 1 }
            },
            {
                texto: "Cautelosa e que sempre alerta sobre riscos e cuidados üö®üõ°Ô∏è",
                pontos: { hacker_futuro: 3, engenheiro_automacao: 2, mestre_vr: 1 }
            }
        ]
    }
];

// Estado da aplica√ß√£o
let perguntaAtual = 0;
let pontuacao = {
    comandante_ia: 0,
    engenheiro_automacao: 0,
    mestre_vr: 0,
    hacker_futuro: 0
};

// Vari√°veis da c√¢mera
let stream = null;
let casaAtual = null;
let cameraModal = null;

// Elementos DOM
const telaInicio = document.getElementById('tela-inicio');
const telaChat = document.getElementById('tela-chat');
const telaResultado = document.getElementById('tela-resultado');
const btnIniciar = document.getElementById('btn-iniciar');
const btnRefazer = document.getElementById('btn-refazer');
const mensagensContainer = document.getElementById('mensagens');
const opcoesContainer = document.getElementById('opcoes');
const progressoFill = document.getElementById('progresso-fill');
const progressoTexto = document.getElementById('progresso-texto');

// Elementos da c√¢mera
const btnTirarFoto = document.getElementById('btn-tirar-foto');
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const btnCapturar = document.getElementById('btn-capturar');
const btnNovaFoto = document.getElementById('btn-nova-foto');
const btnSalvarFoto = document.getElementById('btn-salvar-foto');
const btnCompartilhar = document.getElementById('btn-compartilhar');
const photoPreview = document.getElementById('photo-preview');
const capturedPhoto = document.getElementById('captured-photo');
const overlayBrasao = document.getElementById('overlay-brasao');
const cameraError = document.getElementById('camera-error');

// Event Listeners
document.addEventListener('DOMContentLoaded', function () {
    mostrarTela('inicio');

    // Inicializar modal
    cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));

    // Event listeners b√°sicos
    btnIniciar.addEventListener('click', iniciarChat);
    btnRefazer.addEventListener('click', reiniciarApp);

    // Event listeners da c√¢mera
    btnTirarFoto.addEventListener('click', abrirCamera);
    btnCapturar.addEventListener('click', capturarFoto);
    btnNovaFoto.addEventListener('click', novaFoto);
    btnSalvarFoto.addEventListener('click', salvarFoto);
    btnCompartilhar.addEventListener('click', compartilharInstagram);

    // Limpar stream quando modal fechar
    document.getElementById('cameraModal').addEventListener('hidden.bs.modal', function () {
        pararCamera();
    });
});

// Fun√ß√µes principais do chat (mantidas do c√≥digo original)
function iniciarChat() {
    mostrarTela('chat');
    perguntaAtual = 0;
    pontuacao = {
        comandante_ia: 0,
        engenheiro_automacao: 0,
        mestre_vr: 0,
        hacker_futuro: 0
    };
    mensagensContainer.innerHTML = '';
    mostrarPergunta();
}

function mostrarTela(nomeTela) {
    telaInicio.classList.add('d-none');
    telaChat.classList.add('d-none');
    telaResultado.classList.add('d-none');

    if (nomeTela === 'inicio') {
        telaInicio.classList.remove('d-none');
        telaInicio.classList.add('fade-in');
    } else if (nomeTela === 'chat') {
        telaChat.classList.remove('d-none');
        telaChat.classList.add('fade-in');
    } else if (nomeTela === 'resultado') {
        telaResultado.classList.remove('d-none');
        telaResultado.classList.add('fade-in');
    }
}



function mostrarPergunta() {
    const pergunta = perguntas[perguntaAtual];
    atualizarProgresso();

    const opcoesEmbaralhadas = [...pergunta.opcoes];
    embaralharArray(opcoesEmbaralhadas);

    adicionarMensagem('bot', pergunta.texto);

    // Op√ß√µes aparecem 300ms depois, simulando digita√ß√£o curta
    setTimeout(() => {
        mostrarOpcoes(opcoesEmbaralhadas);
    }, 300);
}


function adicionarMensagem(tipo, texto) {
    const mensagemDiv = document.createElement('div');
    mensagemDiv.className = `mensagem ${tipo}`;

    const avatar = document.createElement('div');
    avatar.className = 'mensagem-avatar';
    avatar.textContent = tipo === 'bot' ? 'ü§ñ' : 'üß©';

    const conteudo = document.createElement('div');
    conteudo.className = 'mensagem-conteudo';
    conteudo.textContent = texto;

    mensagemDiv.appendChild(avatar);
    mensagemDiv.appendChild(conteudo);

    mensagensContainer.appendChild(mensagemDiv);
    mensagensContainer.scrollTop = mensagensContainer.scrollHeight;
}

function mostrarOpcoes(opcoes) {
    opcoesContainer.innerHTML = '';

    opcoes.forEach((opcao, index) => {
        const opcaoDiv = document.createElement('div');
        opcaoDiv.className = 'opcao';
        opcaoDiv.textContent = opcao.texto;
        opcaoDiv.addEventListener('click', () => selecionarOpcao(opcao, index));
        opcoesContainer.appendChild(opcaoDiv);
    });
}

function selecionarOpcao(opcao, index) {
    adicionarMensagem('user', opcao.texto);

    Object.keys(opcao.pontos).forEach(casa => {
        pontuacao[casa] += opcao.pontos[casa];
    });

    opcoesContainer.innerHTML = '';
    perguntaAtual++;

    if (perguntaAtual < perguntas.length) {
        setTimeout(() => {
            mostrarPergunta();
        }, 1000);
    } else {
        setTimeout(() => {
            finalizarChat();
        }, 1500);
    }
}

function atualizarProgresso() {
    const progresso = ((perguntaAtual + 1) / perguntas.length) * 100;
    progressoFill.style.width = `${progresso}%`;
    progressoFill.setAttribute('aria-valuenow', progresso);
    progressoTexto.textContent = `Pergunta ${perguntaAtual + 1} de ${perguntas.length}`;
}

function finalizarChat() {
    let casaVencedora = 'comandante_ia';
    let maiorPontuacao = 0;

    Object.keys(pontuacao).forEach(casa => {
        if (pontuacao[casa] > maiorPontuacao) {
            maiorPontuacao = pontuacao[casa];
            casaVencedora = casa;
        }
    });

    mostrarResultado(casaVencedora);
}

function mostrarResultado(casaId) {
    const casa = casasTech[casaId];
    casaAtual = casaId;

    // Atualizar elementos da tela de resultado
    document.getElementById('casa-brasao').src = casa.img;
    document.getElementById('casa-nome').textContent = casa.nome;
    document.getElementById('casa-lema').textContent = casa.lema;

    // Adicionar descri√ß√£o detalhada
    const descricaoElement = document.getElementById('casa-descricao');
    if (descricaoElement) {
        descricaoElement.textContent = casa.descricao;
    }

    const cores = [
        'bg-primary-subtle',
        'bg-secondary-subtle',
        'bg-success-subtle',
        'bg-danger-subtle',
        'bg-warning-subtle',
        'bg-info-subtle',
        'bg-light-subtle',
        'bg-dark-subtle'
    ];

    const caracteristicasElement = document.getElementById('casa-caracteristicas');
    if (caracteristicasElement) {
        caracteristicasElement.innerHTML = casa.caracteristicas.map(caracteristica => {
            const corAleatoria = cores[Math.floor(Math.random() * cores.length)];
            return `<div class="badge rounded-pill text-dark ${corAleatoria}">${caracteristica}</div>`;
        }).join('');
    }


    // Atualizar lista de cursos com descri√ß√µes detalhadas
    const cursosLista = document.getElementById('cursos-lista');
    cursosLista.innerHTML = '';

    casa.cursos.forEach(curso => {
        const cursoDiv = document.createElement('div');
        cursoDiv.className = 'col-md-6 mb-4';
        cursoDiv.innerHTML = `
                <div class="card h-100 border-0 shadow-sm">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title text-primary">
                    <i class="bi bi-book-fill me-2"></i>
                    ${curso.nome}
                </h5>
                <p class="card-text text-muted small lh-base flex-grow-1">${curso.descricao}</p>

                <a href="${curso.link}" target="_blank" class="btn btn-outline-primary mt-3 align-self-start">
                    Registre seu interesse !!!
                </a>
            </div>
        </div>
        `;
        cursosLista.appendChild(cursoDiv);
    });

    mostrarTela('resultado');
}

function embaralharArray(array) {
    // Algoritmo de Fisher-Yates para embaralhar arrays in-place
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}


function reiniciarApp() {
    perguntaAtual = 0;
    pontuacao = {
        comandante_ia: 0,
        engenheiro_automacao: 0,
        mestre_vr: 0,
        hacker_futuro: 0
    };

    mensagensContainer.innerHTML = '';
    opcoesContainer.innerHTML = '';
    progressoFill.style.width = '0%';
    progressoFill.setAttribute('aria-valuenow', 0);
    progressoTexto.textContent = 'Pergunta 1 de 6';

    mostrarTela('inicio');
}

// Fun√ß√£o para carregar imagem sem problemas de CORS
function carregarImagemSegura(src) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous'; // Tentar CORS primeiro

        img.onload = () => resolve(img);
        img.onerror = () => {
            // Se CORS falhar, tentar sem crossOrigin
            const imgFallback = new Image();
            imgFallback.onload = () => resolve(imgFallback);
            imgFallback.onerror = reject;
            imgFallback.src = src;
        };

        img.src = src;
    });
}

// Fun√ß√£o para converter imagem para canvas sem problemas de CORS
async function imagemParaCanvas(src) {
    try {
        const img = await carregarImagemSegura(src);
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');

        tempCanvas.width = img.width;
        tempCanvas.height = img.height;
        tempCtx.drawImage(img, 0, 0);

        return tempCanvas;
    } catch (error) {
        console.error('Erro ao carregar imagem:', error);
        return null;
    }
}

// Fun√ß√µes da c√¢mera
async function abrirCamera() {
    try {
        cameraError.classList.add('d-none');

        // Configurar overlay do bras√£o
        if (casaAtual) {
            overlayBrasao.src = casasTech[casaAtual].img;
        }

        // Solicitar acesso √† c√¢mera
        stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: 'user',
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        });

        video.srcObject = stream;
        video.play();

        // Resetar estado
        resetarEstadoCamera();

        // Mostrar modal
        cameraModal.show();

    } catch (error) {
        console.error('Erro ao acessar c√¢mera:', error);
        mostrarErroCamera('N√£o foi poss√≠vel acessar a c√¢mera. Verifique as permiss√µes do navegador.');
    }
}

function mostrarErroCamera(mensagem) {
    cameraError.classList.remove('d-none');
    cameraError.innerHTML = `
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        ${mensagem}
    `;
}

function resetarEstadoCamera() {
    video.classList.remove('d-none');
    photoPreview.classList.add('d-none');
    btnCapturar.classList.remove('d-none');
    btnNovaFoto.classList.add('d-none');
    btnSalvarFoto.classList.add('d-none');
    btnCompartilhar.classList.add('d-none');
    cameraError.classList.add('d-none');
}

async function capturarFoto() {
    try {
        const context = canvas.getContext('2d');

        // Definir dimens√µes do canvas baseado no v√≠deo
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Espelhar horizontalmente o v√≠deo no canvas (para bater com a visualiza√ß√£o)
        context.save();
        context.translate(canvas.width, 0);  // move a origem para o canto superior direito
        context.scale(-1, 1);                // inverte horizontalmente
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        context.restore();

        // Adicionar overlay escuro sutil
        const gradient = context.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, 'rgba(0, 0, 0, 0.05)');
        gradient.addColorStop(1, 'rgba(0, 0, 0, 0.15)');
        context.fillStyle = gradient;
        context.fillRect(0, 0, canvas.width, canvas.height);

        // Logo Senac
        await adicionarLogoSenac(context);

        await desenharBrasao(context)

        // Textos decorativos
        await adicionarTextoDecorativo(context);

        // Efeitos visuais
        adicionarEfeitosVisuais(context);

        // Mostrar preview da imagem final
        const dataURL = canvas.toDataURL('image/jpeg', 0.95);
        capturedPhoto.src = dataURL;

        // Atualizar interface
        video.classList.add('d-none');
        photoPreview.classList.remove('d-none');
        btnCapturar.classList.add('d-none');
        btnNovaFoto.classList.remove('d-none');
        btnSalvarFoto.classList.remove('d-none');
        btnCompartilhar.classList.remove('d-none');

    } catch (error) {
        console.error('Erro ao capturar foto:', error);
        mostrarErroCamera('Erro ao capturar foto. Tente novamente.');
    }
}

async function desenharBrasao(context) {
    if (!casaAtual || !casasTech[casaAtual]) return;

    try {
        const brasaoURL = casasTech[casaAtual].img;
        const brasaoCanvas = await imagemParaCanvas(brasaoURL);
        if (!brasaoCanvas) return;

        const brasaoSize = Math.min(canvas.width * 0.35, canvas.height * 0.35);

        // üìç Posi√ß√£o no canto superior direito
        const brasaoX = canvas.width - brasaoSize - 30;
        const brasaoY = 30;

        // Camada 2 do glow ‚Äî ciano
        context.shadowColor = 'rgba(0, 255, 255, 0.4)';
        context.shadowBlur = 40;
        context.drawImage(brasaoCanvas, brasaoX, brasaoY, brasaoSize, brasaoSize);

        // Limpar sombra para n√£o afetar stroke
        context.shadowColor = 'transparent';
        context.shadowBlur = 0;

        // üîµ Moldura circular
        const centerX = brasaoX + brasaoSize / 2;
        const centerY = brasaoY + brasaoSize / 2;
        const radius = brasaoSize / 2;

        context.beginPath();
        context.arc(centerX, centerY, radius + 1.5, 0, 2 * Math.PI); // pequeno ajuste
        context.strokeStyle = 'rgba(255, 255, 255, 0.9)';
        context.lineWidth = 3;
        context.stroke();

    } catch (error) {
        console.error('Erro ao desenhar bras√£o:', error);
    }
}

function novaFoto() {
    resetarEstadoCamera();
}

function salvarFoto() {
    try {
        const dataURL = canvas.toDataURL('image/jpeg', 0.9);
        baixarArquivo(dataURL, `casa-tech-${casaAtual}-${Date.now()}.jpg`);

        // Anima√ß√£o de sucesso
        btnSalvarFoto.classList.add('share-animation');
        setTimeout(() => {
            btnSalvarFoto.classList.remove('share-animation');
        }, 600);

    } catch (error) {
        console.error('Erro ao salvar foto:', error);
        mostrarErroCamera('Erro ao salvar foto. Tente novamente.');
    }
}

// Fun√ß√£o universal para baixar arquivos
function baixarArquivo(dataURL, nomeArquivo) {
    const link = document.createElement('a');
    link.style.display = 'none';
    link.download = nomeArquivo;
    link.href = dataURL;

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

async function compartilharInstagram() {
    try {
        const dataURL = canvas.toDataURL('image/jpeg', 0.9);

        // Tentar usar Web Share API se dispon√≠vel
        if (navigator.share && navigator.canShare) {
            // Converter dataURL para blob
            const response = await fetch(dataURL);
            const blob = await response.blob();
            const file = new File([blob], `casa-tech-${casaAtual}.jpg`, { type: 'image/jpeg' });

            const shareData = {
                title: `Minha Casa Tech - ${casasTech[casaAtual].nome}`,
                text: `Descobri minha Casa Tech no Senac! ${casasTech[casaAtual].lema} #CasaTechSenac #CasaAberta`,
                files: [file]
            };

            if (navigator.canShare(shareData)) {
                await navigator.share(shareData);
            } else {
                compartilharFallback(dataURL);
            }
        } else {
            compartilharFallback(dataURL);
        }

        // Anima√ß√£o de sucesso
        btnCompartilhar.classList.add('share-animation');
        setTimeout(() => {
            btnCompartilhar.classList.remove('share-animation');
        }, 600);

    } catch (error) {
        console.error('Erro ao compartilhar:', error);
        compartilharFallback();
    }
}

function compartilharFallback(dataURL = null) {
    // Fallback: salvar imagem e copiar texto
    const texto = `Descobri minha Casa Tech no Senac! ${casasTech[casaAtual].nome} - ${casasTech[casaAtual].lema} #CasaTechSenac #CasaAberta`;

    // Salvar imagem automaticamente
    if (dataURL) {
        baixarArquivo(dataURL, `casa-tech-${casaAtual}-instagram.jpg`);
    }

    // Copiar texto para clipboard
    if (navigator.clipboard) {
        navigator.clipboard.writeText(texto).then(() => {
            alert('Foto salva e texto copiado! Cole no Instagram junto com sua foto.');
        }).catch(() => {
            alert('Foto salva! Copie este texto para o Instagram:\n\n' + texto);
        });
    } else {
        alert('Foto salva! Copie este texto para o Instagram:\n\n' + texto);
    }

    // Tentar abrir Instagram (funciona melhor em mobile)
    setTimeout(() => {
        const instagramUrl = 'https://www.instagram.com/';
        window.open(instagramUrl, '_blank');
    }, 1000);
}

function pararCamera() {
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    video.srcObject = null;
}

// Tratamento de erros
window.addEventListener('error', function (e) {
    console.error('Erro na aplica√ß√£o:', e.error);
});

// Detectar se √© dispositivo m√≥vel
function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Smooth scroll para mobile
if ('scrollBehavior' in document.documentElement.style) {
    document.documentElement.style.scrollBehavior = 'smooth';
}

async function adicionarLogoSenac(context) {
    try {
        const img = await carregarImagemSegura('img/senac-logo.png');

        // Define a largura da logo em pixels (ajustada para ficar vis√≠vel e proporcional ao canvas)
        const logoWidth = 190;

        // Calcula a altura proporcional da logo com base no aspecto original da imagem (evita distor√ß√£o)
        const logoHeight = (img.height / img.width) * logoWidth;

        // Define o "padding" interno do container da logo ‚Äî espa√ßo entre a borda e a imagem
        const paddingX = 16; // Espa√ßo horizontal
        const paddingY = 10; // Espa√ßo vertical

        // Define o raio de arredondamento dos cantos do fundo da logo (igual ao CSS)
        const borderRadius = 10;

        // Define a espessura da borda branca ao redor do fundo
        const borderWidth = 2;

        // Calcula a largura total da caixinha que envolve a logo (logo + padding dos dois lados)
        const boxWidth = logoWidth + paddingX * 2;

        // Calcula a altura total da caixinha que envolve a logo
        const boxHeight = logoHeight + paddingY * 2;

        // Ajusta o posicionamento respeitando a borda decorativa externa
        const borderOffset = 25; // Dist√¢ncia interna da moldura do canvas (borda que fizemos arredondada)
        const safeMargin = 10;   // Margem de seguran√ßa extra para afastar a logo da borda

        // Calcula a posi√ß√£o X (esquerda) da logo dentro do canvas, considerando o offset + margem
        const posX = borderOffset + safeMargin;

        // Calcula a posi√ß√£o Y (de cima pra baixo), considerando altura total da caixa e margem inferior
        const posY = canvas.height - boxHeight - borderOffset - safeMargin;


        // Define a sombra ao redor do container da logo, simulando o `box-shadow` do CSS
        context.shadowColor = 'rgba(0, 0, 0, 0.3)'; // Cor escura semi-transparente
        context.shadowBlur = 15;                   // Desfoque da sombra
        context.shadowOffsetX = 0;                 // Nenhum deslocamento horizontal
        context.shadowOffsetY = 4;                 // Leve deslocamento vertical (para baixo)

        // Define o fundo do container ‚Äî cor preta com opacidade, como no CSS (.senac-logo-overlay)
        context.fillStyle = 'rgba(0, 0, 0, 0.85)';

        // Define a cor da borda branca com leve transpar√™ncia
        context.strokeStyle = '#ffffffce';

        // Define a espessura da borda
        context.lineWidth = borderWidth;

        // Usa fun√ß√£o auxiliar para desenhar um ret√¢ngulo com cantos arredondados no canvas
        desenharRetanguloArredondado(context, posX, posY, boxWidth, boxHeight, borderRadius);

        // Preenche o container com a cor de fundo (preto transl√∫cido)
        context.fill();

        // Remove sombra antes de desenhar a borda (para n√£o aplicar sombra na linha)
        context.shadowColor = 'transparent';

        // Desenha a borda branca em volta do container
        context.stroke();

        // Desenhar a logo
        context.drawImage(img, posX + paddingX, posY + paddingY, logoWidth, logoHeight);

    } catch (error) {
        console.error('Erro ao adicionar logo Senac:', error);
    }
}


async function adicionarTextoDecorativo(context) {
    try {
        const mainText = '#CasaTechSenac';
        const secondaryText = '#CasaAberta';

        // Fonte real usada
        const fontStack = "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";

        // Estilo CSS: .hashtag-main { font-size: 14px; font-weight: bold; }
        const fontMain = `bold 25px ${fontStack}`;

        // Estilo CSS: .hashtag-secondary { font-size: 12px; color: #FFD700; }
        const fontSecondary = `normal 20px ${fontStack}`;

        const paddingX = 20;
        const paddingY = 18;
        const borderRadius = 20;

        // Medidas baseadas na largura do texto
        context.font = fontMain;
        const widthMain = context.measureText(mainText).width;

        context.font = fontSecondary;
        const widthSecondary = context.measureText(secondaryText).width;

        const maxTextWidth = Math.max(widthMain, widthSecondary);
        const boxWidth = maxTextWidth + paddingX * 2;
        const boxHeight = 32 + paddingY * 2; // altura total para duas linhas compactas

        // Posi√ß√£o (bottom: 20px; right: 20px), ajustando para a borda arredondada do canvas
        const borderOffset = 25; // dist√¢ncia interna da moldura do canvas (borda que fizemos arredondada)
        const safeMargin = 10; // margem de seguran√ßa para afastar o texto da borda

        const posX = canvas.width - boxWidth - borderOffset - safeMargin;
        const posY = canvas.height - boxHeight - borderOffset - safeMargin;

        // Gradiente linear (135deg): escuro suave √† direita
        const gradient = context.createLinearGradient(posX, posY, posX + boxWidth, posY + boxHeight);
        gradient.addColorStop(0, 'rgba(0, 0, 0, 0.3)');
        gradient.addColorStop(1, 'rgba(0, 0, 0, 0.8)');
        context.fillStyle = gradient;

        // Sombra tipo box-shadow
        context.shadowColor = 'rgba(0, 0, 0, 0.3)';
        context.shadowBlur = 15;
        context.shadowOffsetX = 0;
        context.shadowOffsetY = 4;

        desenharRetanguloArredondado(context, posX, posY, boxWidth, boxHeight, borderRadius);
        context.fill();

        // Remove sombra para o texto
        context.shadowColor = 'transparent';

        // Texto principal (branco)
        context.font = fontMain;
        context.fillStyle = '#FFFFFF';
        context.textAlign = 'right';
        context.fillText(mainText, posX + boxWidth - paddingX, posY + paddingY + 14);

        // Texto secund√°rio (dourado)
        context.font = fontSecondary;
        context.fillStyle = '#FFD700';
        context.fillText(secondaryText, posX + boxWidth - paddingX, posY + paddingY + 40);

        context.textAlign = 'left';

    } catch (error) {
        console.error('Erro ao adicionar texto decorativo:', error);
    }
}



// Fun√ß√£o para adicionar efeitos visuais (part√≠culas/estrelas)
function adicionarEfeitosVisuais(context) {
    try {
        // Adicionar estrelas/part√≠culas brilhantes
        const numParticulas = 15;

        for (let i = 0; i < numParticulas; i++) {
            const x = Math.random() * canvas.width;
            const y = Math.random() * canvas.height;
            const size = Math.random() * 3 + 1;
            const opacity = Math.random() * 0.8 + 0.2;

            // Estrela brilhante
            context.fillStyle = `rgba(255, 255, 255, ${opacity})`;
            context.beginPath();
            context.arc(x, y, size, 0, 2 * Math.PI);
            context.fill();

            // Brilho ao redor da estrela
            context.fillStyle = `rgba(255, 215, 0, ${opacity * 0.5})`; // Dourado
            context.beginPath();
            context.arc(x, y, size * 2, 0, 2 * Math.PI);
            context.fill();
        }

        // Adicionar efeito de "scan lines" sutil para look tech
        context.strokeStyle = 'rgba(0, 255, 255, 0.1)'; // Ciano
        context.lineWidth = 1;

        for (let i = 0; i < canvas.height; i += 4) {
            context.beginPath();
            context.moveTo(0, i);
            context.lineTo(canvas.width, i);
            context.stroke();
        }

        // Adicionar borda decorativa
        const borderGradient = context.createLinearGradient(0, 0, canvas.width, canvas.height);
        borderGradient.addColorStop(0, 'rgba(255, 107, 53, 0.8)'); // Laranja Senac
        borderGradient.addColorStop(0.5, 'rgba(0, 255, 255, 0.6)'); // Ciano tech
        borderGradient.addColorStop(1, 'rgba(255, 107, 53, 0.8)'); // Laranja Senac

        context.strokeStyle = borderGradient;
        context.lineWidth = 8;
        const borderRadius = 16;
        desenharRetanguloArredondado(context, 15, 15, canvas.width - 30, canvas.height - 30, borderRadius);
        context.stroke();


    } catch (error) {
        console.error('Erro ao adicionar efeitos visuais:', error);
    }
}

function desenharRetanguloArredondado(ctx, x, y, width, height, radius) {
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.lineTo(x + width - radius, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
    ctx.lineTo(x + width, y + height - radius);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
    ctx.lineTo(x + radius, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
    ctx.lineTo(x, y + radius);
    ctx.quadraticCurveTo(x, y, x + radius, y);
    ctx.closePath();
}
